<script>
    let currentScale = 1;
    let startDistance = 0;
    let isScaling = false;
    
    async function imageToDataURL(img) {
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        return canvas.toDataURL('image/jpeg');
    }

    async function downloadPage() {
        try {
            const images = document.querySelectorAll('img');
            for (let img of images) {
                if (!img.complete) {
                    await new Promise(resolve => img.onload = resolve);
                }
                const dataUrl = await imageToDataURL(img);
                img.setAttribute('src', dataUrl);
            }

            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);

            // Определяем, является ли устройство мобильным
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // Для мобильных устройств используем другой подход
                try {
                    // Пробуем использовать navigator.share если доступно
                    if (navigator.share) {
                        const file = new File([blob], 'gallery.html', { type: 'text/html' });
                        await navigator.share({
                            files: [file],
                            title: 'Галерея изображений',
                        });
                    } else {
                        // Если share API недоступен, пробуем прямое скачивание
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'gallery.html';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 100);
                    }
                } catch (err) {
                    console.error('Ошибка при попытке поделиться файлом:', err);
                    // Если не удалось использовать share API, открываем в новой вкладке
                    window.open(url, '_blank');
                }
            } else {
                // Для десктопов используем стандартный подход
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gallery.html';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
            }
        } catch (error) {
            console.error('Ошибка при скачивании:', error);
            alert('Не удалось скачать галерею. Попробуйте открыть в браузере.');
        }
    }
</script> 